document.addEventListener('DOMContentLoaded', () => {
    const canvasContainer = document.getElementById('canvas-container');
    const contextMenu = document.getElementById('context-menu');
    const canvasContextMenu = document.getElementById('canvas-context-menu');

    let blocks = {};
    let lines = [];
    let blockCounter = 0;
    let lineDrawingState = { startHandle: null, ghostLine: null };
    let isDeleteMode = false;
    let contextTarget = null;
    let clipboard = null; // Î≥µÏÇ¨Îêú Î∏îÎ°ù Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•
    let lastContextMenuPos = { x: 0, y: 0 }; // Î∂ôÏó¨ÎÑ£Í∏∞ ÏúÑÏπò Ï†ÄÏû•

    /* =========================================================
     * üîß 1. Í≥µÌÜµ Ïä§ÌÉÄÏùº Ï£ºÏûÖ (ÏÑ† ÏÇ≠Ï†ú Í∞ÄÎä• + Ïª§ÏÑú ÌëúÏãú)
     * ========================================================= */
    const ensureDeleteStyle = () => {
        if (!document.getElementById('line-delete-style')) {
            const st = document.createElement('style');
            st.id = 'line-delete-style';
            st.textContent = `
            svg.leader-line.line-deletable {
                cursor: pointer !important;
            }
            svg.leader-line.line-deletable .leader-line-path,
            svg.leader-line.line-deletable .leader-line-arrow {
                pointer-events: stroke !important;
            }
            `;
            document.head.appendChild(st);
        }
    };
    ensureDeleteStyle();

    /* =========================================================
     * üîß 2. Í≥†Ïä§Ìä∏(ÏûÑÏãú) ÏÑ† Ï†ïÎ¶¨ Ïú†Ìã∏Î¶¨Ìã∞
     * ========================================================= */
    const cancelGhostLine = () => {
        if (lineDrawingState.ghostLine) {
            try { lineDrawingState.ghostLine.remove(); } catch (_) {}
            lineDrawingState.ghostLine = null;
        }
        lineDrawingState.startHandle = null;
    };

    /* =========================================================
     * 3. Î∏îÎ°ù(Í∏∞Î≥∏¬∑Î∂ÑÍ∏∞) ÏÉùÏÑ±
     * ========================================================= */
    function createBlock(id, x, y, width, height, type = 'default', data = {}) {
        const blockEl = document.createElement('div');
        blockEl.id = id;
        blockEl.className = `block ${type}-block`;
        blockEl.style.left = `${x}px`;
        blockEl.style.top = `${y}px`;
        blockEl.style.width = `${width}px`;
        if (height) blockEl.style.height = `${height}px`;
        if (data.color) blockEl.style.backgroundColor = data.color;

        blockEl.setAttribute('data-x', x);
        blockEl.setAttribute('data-y', y);

        const topContainer = document.createElement('div');
        topContainer.className = 'flex-grow w-full flex flex-col items-center justify-center';

        const labelWrapper = document.createElement('div');
        labelWrapper.className = 'block-input-wrapper';

        const label = document.createElement('div');
        label.className = 'block-label';
        label.textContent = data.label || `Î∏îÎ°ù ${id.split('-')[1]}`;
        if (data.fontSize) label.style.fontSize = data.fontSize;

        labelWrapper.appendChild(label);
        topContainer.appendChild(labelWrapper);

        let branchesContainer;
        if (type === 'branch') {
            branchesContainer = document.createElement('div');
            branchesContainer.className = 'branches-container mt-2';
            topContainer.appendChild(branchesContainer);
        }

        blockEl.appendChild(topContainer);

        const bottomContainer = document.createElement('div');
        if (type === 'branch') {
            const addBranchBtn = document.createElement('button');
            addBranchBtn.className = 'add-branch-btn';
            addBranchBtn.textContent = '+ Î∂ÑÍ∏∞ Ï∂îÍ∞Ä';
            addBranchBtn.onclick = (e) => {
                e.stopPropagation();
                const newBranchId = `branch-${Date.now()}`;
                blocks[id].branches.push({ id: newBranchId, text: 'ÏÉà Ï°∞Í±¥' });
                addBranchToBlock(id, newBranchId, 'ÏÉà Ï°∞Í±¥');
            };
            bottomContainer.appendChild(addBranchBtn);
        }
        blockEl.appendChild(bottomContainer);

        canvasContainer.appendChild(blockEl);

        if (!blocks[id]) {
            blocks[id] = {
                el: blockEl, x, y, width,
                height: blockEl.offsetHeight, type,
                label: label.textContent, color: data.color || null, fontSize: data.fontSize || null,
                branches: type === 'branch' ? data.branches || [{ id: `branch-${Date.now()}`, text: 'Ï°∞Í±¥ 1' }] : [],
            };
        }

        if (type === 'branch') {
            const branchesToCreate = data.branches || blocks[id].branches;
            blocks[id].branches = branchesToCreate;
            branchesToCreate.forEach((branchData) => {
                addBranchToBlock(id, branchData.id, branchData.text);
            });
        }

        ['top', 'right', 'bottom', 'left'].forEach((pos) => {
            const handle = document.createElement('div');
            handle.className = `handle handle-${pos}`;
            handle.dataset.blockId = id;
            handle.dataset.handleId = pos;
            blockEl.appendChild(handle);
        });

        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'delete-block-btn';
        deleteBtn.innerHTML = '&times;';
        deleteBtn.onclick = (e) => { e.stopPropagation(); deleteBlock(id); };
        blockEl.appendChild(deleteBtn);

        const resizeHandle = document.createElement('div');
        resizeHandle.className = 'resize-handle';
        blockEl.appendChild(resizeHandle);

        setupBlockInteractions(blockEl);
        autoResizeBlock(id);
        return blockEl;
    }

    /* =========================================================
     * 4. Î∏îÎ°ù/Î∏åÎûúÏπò ÏÇ≠Ï†ú Î°úÏßÅ
     * ========================================================= */
    function deleteBlock(blockId, force = false) {
        if (!isDeleteMode && !force) return; // [MODIFIED] Í∞ïÏ†ú ÏÇ≠Ï†úÍ∞Ä ÏïÑÎãàÍ≥†, ÏÇ≠Ï†ú Î™®ÎìúÍ∞Ä ÏïÑÎãàÎ©¥ Ïã§Ìñâ ÏïàÌï®

        lines = lines.filter((line) => {
            if (line.sourceBlock === blockId || line.targetBlock === blockId) {
                line.instance?.remove();
                return false;
            }
            return true;
        });
        blocks[blockId]?.el.remove();
        delete blocks[blockId];
        updateLines();
    }

    function deleteBranch(blockId, branchId) {
        if (!isDeleteMode) return;
        lines = lines.filter((line) => {
            const srcHit = line.sourceBlock === blockId && line.sourceHandle.startsWith(branchId);
            const tgtHit = line.targetBlock === blockId && line.targetHandle.startsWith(branchId);
            if (srcHit || tgtHit) {
                line.instance?.remove();
                return false;
            }
            return true;
        });
        const block = blocks[blockId];
        block.branches = block.branches.filter((b) => b.id !== branchId);
        block.el.querySelector(`.branch[data-branch-id="${branchId}"]`)?.remove();
        autoResizeBlock(blockId);
    }

    /* =========================================================
     * 5. Î∏åÎûúÏπò Ï∂îÍ∞Ä / Î∏îÎ°ù ÏûêÎèô ÎÜíÏù¥ Ï°∞Ï†ï
     * ========================================================= */
    function addBranchToBlock(blockId, branchId, text) {
        const blockEl = blocks[blockId].el;
        const branchContainer = blockEl.querySelector('.branches-container');
        const branchDiv = document.createElement('div');
        branchDiv.className = 'branch';
        branchDiv.dataset.branchId = branchId;

        const branchInput = document.createElement('input');
        branchInput.type = 'text';
        branchInput.className = 'branch-input';
        branchInput.value = text;
        branchInput.onclick = (e) => e.stopPropagation();
        branchInput.oninput = () => {
            const branch = blocks[blockId].branches.find((b) => b.id === branchId);
            if (branch) branch.text = branchInput.value;
        };

        const leftHandle = document.createElement('div');
        leftHandle.className = 'handle handle-left';
        leftHandle.dataset.blockId = blockId;
        leftHandle.dataset.handleId = `${branchId}-left`;

        const rightHandle = document.createElement('div');
        rightHandle.className = 'handle handle-right';
        rightHandle.dataset.blockId = blockId;
        rightHandle.dataset.handleId = `${branchId}-right`;

        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'delete-branch-btn';
        deleteBtn.innerHTML = '&times;';
        deleteBtn.onclick = (e) => { e.stopPropagation(); deleteBranch(blockId, branchId); };

        branchDiv.appendChild(leftHandle);
        branchDiv.appendChild(branchInput);
        branchDiv.appendChild(rightHandle);
        branchDiv.appendChild(deleteBtn);
        branchContainer.appendChild(branchDiv);

        setupBlockInteractions(branchDiv);
        autoResizeBlock(blockId);
    }

    function autoResizeBlock(blockId) {
        const block = blocks[blockId];
        if (!block) return;
        const blockEl = block.el;
        blockEl.style.height = 'auto';
        const preferred = blockEl.scrollHeight;
        const min = block.type === 'branch' ? 140 : 80;
        blockEl.style.height = `${Math.max(min, preferred)}px`;
        block.height = blockEl.offsetHeight;
        updateLines();
    }

    /* =========================================================
     * 6. Î∏îÎ°ù Ï∂îÍ∞Ä Î≤ÑÌäº Ìó¨Ìçº
     * ========================================================= */
    function addNewBlock(type) {
        blockCounter += 1;
        const id = `block-${blockCounter}`;
        const offset = Object.keys(blocks).length % 5;
        const x = 50 + offset * 20;
        const y = 50 + offset * 20;
        const width = type === 'branch' ? 220 : 180;
        createBlock(id, x, y, width, null, type,
            type === 'branch' ? { label: 'Ï°∞Í±¥ Î∂ÑÍ∏∞' } : { label: `ÏùºÎ∞ò Î∏îÎ°ù ${blockCounter}` }
        );
    }

    /* =========================================================
     * 7. Ïù∏ÌÑ∞ÎûôÏÖò ÏÑ∏ÌåÖ
     * ========================================================= */
    function setupBlockInteractions(el) {
        const label = el.querySelector('.block-label');
        if (label) {
            label.addEventListener('dblclick', (e) => {
                e.stopPropagation();
                const blockEl = el.closest('.block');
                if (!blockEl) return;

                const wrapper = label.parentElement;
                const textarea = document.createElement('textarea');
                textarea.className = 'block-input';
                textarea.value = label.textContent;
                label.style.display = 'none';
                wrapper.appendChild(textarea);

                const autosize = () => {
                    textarea.style.height = 'auto';
                    textarea.style.height = `${textarea.scrollHeight}px`;
                    autoResizeBlock(blockEl.id);
                };
                textarea.addEventListener('input', autosize);

                textarea.focus();
                autosize();

                const finish = () => {
                    label.textContent = textarea.value;
                    blocks[blockEl.id].label = textarea.value;
                    label.style.display = 'flex';
                    textarea.remove();
                    autoResizeBlock(blockEl.id);
                };
                textarea.addEventListener('blur', finish);
                textarea.addEventListener('keydown', (ev) => {
                    if (ev.key === 'Enter' && !ev.shiftKey) {
                        ev.preventDefault();
                        finish();
                    }
                });
            });
        }

        el.querySelectorAll('.handle').forEach((handle) => {
            handle.addEventListener('mousedown', (e) => {
                e.stopPropagation();
                if (isDeleteMode) return;
                cancelGhostLine();
                lineDrawingState.startHandle = e.currentTarget;

                lineDrawingState.ghostLine = new LeaderLine(
                    lineDrawingState.startHandle,
                    LeaderLine.pointAnchor({ x: e.clientX, y: e.clientY }),
                    { color: 'rgba(255,255,100,0.7)', size: 3, dash: { animation: true } }
                );

                lineDrawingState.ghostLine.path?.parentElement?.style.setProperty('pointer-events', 'none');
            });
        });
    }

    document.body.addEventListener('mousemove', (e) => {
        if (lineDrawingState.ghostLine) {
            lineDrawingState.ghostLine.end = LeaderLine.pointAnchor({ x: e.clientX, y: e.clientY });
        }
    });

    document.body.addEventListener('mouseup', (e) => {
        if (lineDrawingState.ghostLine) {
            try { lineDrawingState.ghostLine.remove(); } catch (_) {}
        }

        const startHandle = lineDrawingState.startHandle;
        if (startHandle) {
            const endEl = document.elementFromPoint(e.clientX, e.clientY);
            const endHandle = endEl?.closest('.handle');

            if (endHandle && startHandle !== endHandle && startHandle.dataset.blockId !== endHandle.dataset.blockId) {
                const sourceBlockId = startHandle.dataset.blockId;
                const sourceHandleId = startHandle.dataset.handleId;
                const targetBlockId = endHandle.dataset.blockId;
                const targetHandleId = endHandle.dataset.handleId;

                const exists = lines.some((l) =>
                    l.sourceBlock === sourceBlockId && l.sourceHandle === sourceHandleId &&
                    l.targetBlock === targetBlockId && l.targetHandle === targetHandleId
                );

                if (!exists) {
                    const lineId = `line-${Date.now()}`;
                    const leader = new LeaderLine(startHandle, endHandle, {
                        color: 'rgba(255,255,255,0.7)', size: 3,
                        path: 'fluid', endPlug: 'arrow1',
                    });
                    lines.push({
                        instance: leader, id: lineId,
                        sourceBlock: sourceBlockId, sourceHandle: sourceHandleId,
                        targetBlock: targetBlockId, targetHandle: targetHandleId,
                        color: null,
                    });
                    setTimeout(updateLineDeleteListeners, 0);
                }
            }
        }
        cancelGhostLine();
    });

    window.addEventListener('mouseleave', cancelGhostLine);

    /* =========================================================
     * 8. ÏÑ† ÏúÑÏπò Ïã§ÏãúÍ∞Ñ ÏóÖÎç∞Ïù¥Ìä∏
     * ========================================================= */
    function updateLines() {
        lines.forEach((l) => { try { l.instance?.position(); } catch (_) {} });
    }

    /* =========================================================
 * 9. ÏÇ≠Ï†ú Î™®ÎìúÏö© ÏÑ† ÌÅ¥Î¶≠ Î¶¨Ïä§ÎÑà Í¥ÄÎ¶¨  üíñ
 /* =========================================================
 /* =========================================================
 * 9. ÏÇ≠Ï†ú Î™®ÎìúÏö© ÏÑ† ÌÅ¥Î¶≠/ÌïÄ Í¥ÄÎ¶¨ (Ï†ÑÎ©¥ ÍµêÏ≤¥)
 * ========================================================= */
function positionDeleteBtn(line) {
  const btn = line.deleteBtn;
  if (!btn) return;

  const srcBox = line.instance.start.getBoundingClientRect();
  const tgtBox = line.instance.end.getBoundingClientRect();
  const midX = (srcBox.left + srcBox.right + tgtBox.left + tgtBox.right) / 4;
  const midY = (srcBox.top + srcBox.bottom + tgtBox.top + tgtBox.bottom) / 4;
  btn.style.left = `${midX}px`;
  btn.style.top  = `${midY}px`;
}

function updateLineDeleteListeners() {
  lines.forEach((line) => {
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ ÏÇ≠Ï†ú Î™®Îìú ON ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    if (isDeleteMode) {
      // ‚ë† ÏÑ† ÏÉâ Îπ®Í∞õÍ≤å(Ìïú Î≤àÎßå)
      if (!line.originalColor) {
        line.originalColor = line.instance.color;
        line.instance.setOptions({ color: '#e54b4b' });
      }

      // ‚ë° ‚ùå ÌïÄ ÏÉùÏÑ±
      if (!line.deleteBtn) {
        const btn = document.createElement('div');
        btn.className = 'line-delete-btn';
        btn.textContent = '√ó';
        btn.onclick = (e) => {
          e.stopPropagation();
          deleteLine(line.id);
        };
        document.body.appendChild(btn);
        line.deleteBtn = btn;
        positionDeleteBtn(line);
      }
    }
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ ÏÇ≠Ï†ú Î™®Îìú OFF ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    else {
      if (line.originalColor) {
        line.instance.setOptions({ color: line.originalColor });
        line.originalColor = null;
      }
      if (line.deleteBtn) {
        line.deleteBtn.remove();
        line.deleteBtn = null;
      }
    }
  });
}

/* ÏÑ†¬∑Î∏îÎ°ù Ïù¥Îèô Ïãú ‚ùå ÏúÑÏπò Í∞±Ïã† */
function refreshDeletePins() {
  if (!isDeleteMode) return;
  lines.forEach(positionDeleteBtn);
}

/* deleteLine ‚Üí ÌïÄ/ÏÑ† ÎèôÏãú Ï†úÍ±∞ */
function deleteLine(id) {
  const idx = lines.findIndex((l) => l.id === id);
  if (idx === -1) return;

  const line = lines[idx];
  line.instance?.remove();
  line.deleteBtn?.remove();
  lines.splice(idx, 1);
}

/* Í∏∞Ï°¥ updateLines() Ìò∏Ï∂ú Îí§Ïóê ÌïÄÎèÑ Ïù¥ÎèôÌïòÎèÑÎ°ù ÎçÆÏñ¥Ïì∞Í∏∞ */
const _origUpdateLines = updateLines;
updateLines = function () {
  _origUpdateLines();
  refreshDeletePins();
};


    /* =========================================================
     * 10. Interact.js (ÎìúÎûòÍ∑∏ + Î¶¨ÏÇ¨Ïù¥Ï¶à)
     * ========================================================= */
    interact('.block')
        .draggable({
            allowFrom: '.block-label',
            listeners: {
                start(ev) {
                    const t = ev.currentTarget;
                    const st = window.getComputedStyle(t);
                    t.setAttribute('data-x', parseFloat(st.left) || 0);
                    t.setAttribute('data-y', parseFloat(st.top) || 0);
                },
                move(ev) {
                    const t = ev.currentTarget;
                    const x = (parseFloat(t.getAttribute('data-x')) || 0) + ev.dx;
                    const y = (parseFloat(t.getAttribute('data-y')) || 0) + ev.dy;
                    t.style.left = `${x}px`;
                    t.style.top = `${y}px`;
                    t.setAttribute('data-x', x);
                    t.setAttribute('data-y', y);
                    if (blocks[t.id]) {
                        blocks[t.id].x = x;
                        blocks[t.id].y = y;
                    }
                    updateLines();
                },
            },
            modifiers: [interact.modifiers.restrictRect({ restriction: '#canvas-container' })],
        })
        .resizable({
            edges: { right: '.resize-handle', bottom: '.resize-handle' },
            listeners: {
                move(ev) {
                    const t = ev.target;
                    const blk = blocks[t.id];
                    if (!blk) return;
                    t.style.width = `${ev.rect.width}px`;
                    t.style.height = `${ev.rect.height}px`;
                    blk.width = ev.rect.width;
                    blk.height = ev.rect.height;
                    updateLines();
                },
            },
            modifiers: [interact.modifiers.restrictSize({ min: { width: 120, height: 80 } })],
        });

    /* =========================================================
     * 11. Ïª®ÌÖçÏä§Ìä∏ Î©îÎâ¥(Î≥µÏÇ¨, Î∂ôÏó¨ÎÑ£Í∏∞, ÏÉâÏÉÅ, Ìè∞Ìä∏ Îì±)
     * ========================================================= */
    document.addEventListener('contextmenu', (e) => {
        e.preventDefault();
        const blkEl = e.target.closest('.block');
        
        contextMenu.style.display = 'none';
        canvasContextMenu.style.display = 'none';

        if (blkEl) {
            contextTarget = { type: 'block', id: blkEl.id };
            contextMenu.style.display = 'block';
            contextMenu.style.left = `${e.clientX}px`;
            contextMenu.style.top = `${e.clientY}px`;
        } else if (e.target === canvasContainer) {
            lastContextMenuPos = { x: e.clientX, y: e.clientY };
            const pasteButton = document.getElementById('paste-block');
            pasteButton.disabled = !clipboard;

            canvasContextMenu.style.display = 'block';
            canvasContextMenu.style.left = `${e.clientX}px`;
            canvasContextMenu.style.top = `${e.clientY}px`;
        }
    });

    document.addEventListener('click', (e) => {
        if (!contextMenu.contains(e.target)) contextMenu.style.display = 'none';
        if (!canvasContextMenu.contains(e.target)) canvasContextMenu.style.display = 'none';
    });

    contextMenu.addEventListener('click', (e) => {
        e.stopPropagation();
        const color = e.target.dataset.color;
        if (color && contextTarget?.type === 'block') {
            const blk = blocks[contextTarget.id];
            blk.el.style.backgroundColor = color;
            blk.color = color;
        }
    });
    
    document.getElementById('copy-block').onclick = () => {
        if (contextTarget?.type === 'block') {
            const sourceBlock = blocks[contextTarget.id];
            if (sourceBlock) {
                clipboard = {
                    type: sourceBlock.type,
                    width: sourceBlock.width,
                    label: sourceBlock.label,
                    color: sourceBlock.color,
                    fontSize: sourceBlock.fontSize,
                    branches: sourceBlock.branches.map(branch => ({ text: branch.text }))
                };
            }
        }
        contextMenu.style.display = 'none';
    };

    // [NEW] Ïª®ÌÖçÏä§Ìä∏ Î©îÎâ¥ÏóêÏÑú Î∏îÎ°ù ÏÇ≠Ï†ú
    document.getElementById('delete-block-context').onclick = () => {
        if (contextTarget?.type === 'block') {
            const blockToDelete = blocks[contextTarget.id];
            if (blockToDelete && confirm(`'${blockToDelete.label}' Î∏îÎ°ùÏùÑ Ï†ïÎßêÎ°ú ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) {
                deleteBlock(contextTarget.id, true); // Í∞ïÏ†ú ÏÇ≠Ï†ú ÏòµÏÖòÏúºÎ°ú Ìò∏Ï∂ú
            }
        }
        contextMenu.style.display = 'none';
    };

    document.getElementById('paste-block').onclick = () => {
        if (!clipboard) return;

        const canvasRect = canvasContainer.getBoundingClientRect();
        const x = lastContextMenuPos.x - canvasRect.left + canvasContainer.scrollLeft;
        const y = lastContextMenuPos.y - canvasRect.top + canvasContainer.scrollTop;

        blockCounter++;
        const newId = `block-${blockCounter}`;
        
        const dataForCreation = { ...clipboard };
        if (dataForCreation.type === 'branch' && dataForCreation.branches) {
            dataForCreation.branches = dataForCreation.branches.map((branch, index) => ({
                id: `branch-${Date.now()}-${index}`,
                text: branch.text
            }));
        }

        createBlock(newId, x, y, dataForCreation.width, null, dataForCreation.type, dataForCreation);
        canvasContextMenu.style.display = 'none';
    };

    const changeFontSize = (block, dir) => {
        const lbl = block.el.querySelector('.block-label');
        if (!lbl) return;
        const cur = parseFloat(window.getComputedStyle(lbl).fontSize);
        const next = dir === 'increase' ? cur + 1 : cur - 1;
        if (next < 8 || next > 40) return;
        lbl.style.fontSize = `${next}px`;
        block.fontSize = `${next}px`;
        autoResizeBlock(block.el.id);
    };
    document.getElementById('increase-font').onclick = () => {
        if (contextTarget?.type === 'block') changeFontSize(blocks[contextTarget.id], 'increase');
    };
    document.getElementById('decrease-font').onclick = () => {
        if (contextTarget?.type === 'block') changeFontSize(blocks[contextTarget.id], 'decrease');
    };

    /* =========================================================
     * 12. Ìà¥Î∞î Î≤ÑÌäº Ïó∞Í≤∞
     * ========================================================= */
    document.getElementById('add-block').onclick = () => addNewBlock('default');
    document.getElementById('add-branch-block').onclick = () => addNewBlock('branch');
    document.getElementById('delete-mode-toggle').onclick = () => {
        isDeleteMode = !isDeleteMode;
        canvasContainer.classList.toggle('delete-mode-active', isDeleteMode);
        document.getElementById('delete-mode-toggle').classList.toggle('active', isDeleteMode);
        updateLineDeleteListeners();
    };

    function saveState() {
        const bl = Object.entries(blocks).map(([id, b]) => ({
            id, x: b.x, y: b.y, width: b.width, height: b.height,
            type: b.type, label: b.label, branches: b.branches,
            color: b.color, fontSize: b.fontSize,
        }));
        const ln = lines.map((l) => ({
            sourceBlock: l.sourceBlock, sourceHandle: l.sourceHandle,
            targetBlock: l.targetBlock, targetHandle: l.targetHandle,
            color: l.color,
        }));
        localStorage.setItem('diagramState', JSON.stringify({ blocks: bl, lines: ln, blockCounter }));
        alert('ÏûëÏóÖ ÎÇ¥Ïö©Ïù¥ Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.');
    }

    function loadState() {
        const raw = localStorage.getItem('diagramState');
        if (!raw) return;
        const state = JSON.parse(raw);
        clearCanvas();
        blockCounter = state.blockCounter || 0;
        state.blocks.forEach((b) => createBlock(b.id, b.x, b.y, b.width, b.height, b.type, b));
        state.lines.forEach((l) => {
            const src = document.querySelector(`#${l.sourceBlock} .handle[data-handle-id="${l.sourceHandle}"]`);
            const tgt = document.querySelector(`#${l.targetBlock} .handle[data-handle-id="${l.targetHandle}"]`);
            if (src && tgt) {
                const id = `line-${Date.now()}`;
                const leader = new LeaderLine(src, tgt, {
                    color: l.color || 'rgba(255,255,255,0.7)', size: 3,
                    path: 'fluid', endPlug: 'arrow1',
                });
                lines.push({ ...l, id, instance: leader });
            }
        });
        setTimeout(updateLineDeleteListeners, 0);
    }

    function clearCanvas() {
        lines.forEach((l) => l.instance?.remove());
        lines = [];
        Object.values(blocks).forEach((b) => b.el.remove());
        blocks = {};
        blockCounter = 0;
    }

    document.getElementById('save-diagram').onclick = saveState;
    document.getElementById('load-diagram').onclick = () => {
        if (confirm('Ï†ïÎßêÎ°ú Î∂àÎü¨Ïò§ÏãúÍ≤†ÏäµÎãàÍπå? ÌòÑÏû¨ ÏûëÏóÖ ÎÇ¥Ïö©ÏùÄ Ï†ÄÏû•ÎêòÏßÄ ÏïäÍ≥† ÏÇ¨ÎùºÏßëÎãàÎã§.')) loadState();
    };
    document.getElementById('clear-diagram').onclick = () => {
        if (confirm('Ï†ïÎßêÎ°ú Î™®Îì† ÏûëÏóÖÏùÑ ÏßÄÏö∞ÏãúÍ≤†ÏäµÎãàÍπå?')) clearCanvas();
    };

function generatePrompt() {
        const out = document.getElementById('prompt-output');
        const modal = document.getElementById('prompt-modal');

        // --- YAML ÏÉùÏÑ±ÏùÑ ÏúÑÌïú ÏÉàÎ°úÏö¥ Î°úÏßÅ ---

        // 1. Î™®Îì† Î∏îÎ°ùÍ≥º Ïó∞Í≤∞ÏÑ†ÏúºÎ°úÎ∂ÄÌÑ∞ ÌÉÄÍ≤üÏù¥ ÎêòÎäî Î∏îÎ°ù ID ÏßëÌï© ÏÉùÏÑ±
        const targetBlockIds = new Set(lines.map(line => line.targetBlock));
        
        // 2. ÌîåÎ°úÏö∞ ÏãúÏûëÏ†ê Ï∞æÍ∏∞ (Îã§Î•∏ Î∏îÎ°ùÏùò ÌÉÄÍ≤üÏù¥ ÏïÑÎãå Î∏îÎ°ù)
        const startNodes = Object.values(blocks).filter(block => !targetBlockIds.has(block.el.id));
        
        // 3. Ïó∞Í≤∞Ïù¥ Ï†ÑÌòÄ ÏóÜÎäî Î∏îÎ°ù Ï∞æÍ∏∞ (Ï†ÑÏó≠ ÏßÄÏãúÏÇ¨Ìï≠ÏúºÎ°ú Í∞ÑÏ£º)
        const sourceBlockIds = new Set(lines.map(line => line.sourceBlock));
        const unconnectedNodes = Object.values(blocks).filter(block => 
            !targetBlockIds.has(block.el.id) && !sourceBlockIds.has(block.el.id)
        );

        // Ï†úÎ™©(title)ÏúºÎ°ú ÏÇ¨Ïö©Ìï† Î∏îÎ°ù Ï∞æÍ∏∞ (Ïòà: Í∞ÄÏû• ÏúÑÏóê ÏûàÎäî ÎØ∏Ïó∞Í≤∞ Î∏îÎ°ù)
        const titleNode = unconnectedNodes.sort((a, b) => a.y - b.y)[0];
        const globalInstructions = unconnectedNodes.filter(n => n !== titleNode);

        // [MODIFIED] ÌîÑÎ°¨ÌîÑÌä∏ ÏµúÏÉÅÎã®Ïóê ÏßÄÏãú Î¨∏Íµ¨ Ï∂îÍ∞Ä
        let yamlOutput = "ÏïÑÎûò ÌùêÎ¶ÑÏóê Îî∞Îùº ÏΩîÎî©ÏùÑ ÌïòÏó¨ ÏôÑÏÑ±Îêú ÌîÑÎ°úÍ∑∏Îû®ÏùÑ Ï†úÏãúÌï† Í≤É\n\n---\n\n";
        
        // YAMLÏùò Í∏∞Î≥∏ Íµ¨Ï°∞ ÏÉùÏÑ±
        if (titleNode) {
            yamlOutput += `title: ${titleNode.label}\n`;
        }

        if (globalInstructions.length > 0) {
            yamlOutput += "global_instructions:\n";
            globalInstructions.forEach(node => {
                yamlOutput += `  - ${node.label}\n`;
            });
        }

        yamlOutput += "flow:\n";

        // 4. ÌîåÎ°úÏö∞ ÏàúÌöå Î∞è YAML Î≥ÄÌôò Ìï®Ïàò
        const processedBlocks = new Set();
        let stepCounter = 1;

        function buildFlowYaml(blockId, indent = "  ") {
            if (processedBlocks.has(blockId)) return;
            
            const block = blocks[blockId];
            if (!block) return;
            
            processedBlocks.add(blockId);
            const currentStep = stepCounter++;

            if (block.type !== 'branch') {
                yamlOutput += `${indent}- step: ${currentStep}\n`;
                yamlOutput += `${indent}  description: ${block.label}\n`;
                
                const nextLine = lines.find(line => line.sourceBlock === blockId);
                if (nextLine) {
                    buildFlowYaml(nextLine.targetBlock, indent);
                }
            } else {
                yamlOutput += `${indent}- step: ${currentStep}\n`;
                yamlOutput += `${indent}  type: branch\n`;
                yamlOutput += `${indent}  description: ${block.label}\n`;
                yamlOutput += `${indent}  conditions:\n`;

                block.branches.forEach(branch => {
                    yamlOutput += `${indent}    - condition: ${branch.text}\n`;
                    
                    const branchLine = lines.find(line => line.sourceHandle.startsWith(branch.id));
                    if (branchLine) {
                        yamlOutput += `${indent}      next_steps:\n`;
                        buildBranchSteps(branchLine.targetBlock, `${indent}        `, 1);
                    }
                });
            }
        }
        
        function buildBranchSteps(blockId, indent, subStep) {
             const block = blocks[blockId];
             if (!block) return;

             yamlOutput += `${indent}- step: ${subStep}\n`;
             yamlOutput += `${indent}  description: ${block.label}\n`;
             
             const nextLine = lines.find(line => line.sourceBlock === blockId);
             if (nextLine) {
                 buildBranchSteps(nextLine.targetBlock, indent, subStep + 1);
             }
        }

        // 5. ÏãúÏûë ÎÖ∏ÎìúÎ∂ÄÌÑ∞ ÏàúÌöå ÏãúÏûë
        const flowStartNodes = startNodes.filter(node => !unconnectedNodes.includes(node));
        flowStartNodes.forEach(startNode => {
             buildFlowYaml(startNode.el.id);
        });
        
        out.value = yamlOutput;
        modal.classList.remove('hidden');
    }

    // [NEW] Î≥µÏÇ¨ÌïòÍ∏∞ Î∞è ÌååÏùº Ï†ÄÏû• Î≤ÑÌäº Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà
    document.getElementById('copy-prompt-btn').onclick = () => {
        const promptText = document.getElementById('prompt-output').value;
        navigator.clipboard.writeText(promptText).then(() => {
            alert('ÌîÑÎ°¨ÌîÑÌä∏Í∞Ä ÌÅ¥Î¶ΩÎ≥¥ÎìúÏóê Î≥µÏÇ¨ÎêòÏóàÏäµÎãàÎã§.');
        }).catch(err => {
            console.error('Î≥µÏÇ¨ Ïã§Ìå®:', err);
            alert('Î≥µÏÇ¨Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
        });
    };

    document.getElementById('save-prompt-btn').onclick = () => {
        const promptText = document.getElementById('prompt-output').value;
        const blob = new Blob([promptText], { type: 'text/yaml;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'prompt.yaml';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    };

    // Í∏∞Ï°¥ generate-prompt Î≤ÑÌäº Ïó∞Í≤∞Î∂ÄÎäî Í∑∏ÎåÄÎ°ú Ïú†ÏßÄ
    document.getElementById('generate-prompt').onclick = generatePrompt;
    document.getElementById('close-modal').onclick = () =>
        document.getElementById('prompt-modal').classList.add('hidden');

//... (Ïù¥Ï†Ñ ÏΩîÎìú ÏÉùÎûµ) ...

    /* =========================================================
     * 13. Ï≤òÏùå Î°úÎìúÏãú ÏÉÅÌÉú Î≥µÍµ¨
     * ========================================================= */
    loadState();
});